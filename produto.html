<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produto Personalizado - PersoIta</title>
    <meta name="description" content="Personalize este produto com sua arte, foto ou texto. Criamos produtos únicos e de qualidade.">
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos temporários para evitar erros antes do CSS carregar */
        .product-not-found {
            text-align: center;
            padding: 40px;
            grid-column: 1 / -1;
        }
        .no-related {
            text-align: center;
            padding: 20px;
            color: #6C757D;
        }
        
        /* Estilos de loading */
        .loading-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Novos estilos */
        .variations-container {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        
        .variation-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .variation-btn {
            padding: 10px 20px;
            border: 2px solid #dee2e6;
            background-color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .variation-btn:hover {
            border-color: #4A6FA5;
        }
        
        .variation-btn.active {
            border-color: #4A6FA5;
            background-color: #4A6FA5;
            color: white;
        }
        
        .variation-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .whatsapp-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background-color: #25D366;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            margin-top: 20px;
            border: none;
            cursor: pointer;
            width: 100%;
        }
        
        .whatsapp-button:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }
        
        .whatsapp-button i {
            font-size: 1.3rem;
        }
        
        .product-features {
            margin: 25px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        
        .product-features h3 {
            margin-bottom: 15px;
            color: #2C3E50;
        }
        
        .product-features ul {
            list-style: none;
            padding-left: 0;
        }
        
        .product-features li {
            padding: 8px 0;
            display: flex;
            align-items: center;
        }
        
        .product-features li i {
            color: #4A6FA5;
            margin-right: 10px;
        }
        
        .product-simple {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 30px;
        }
        
        /* Estilo para imagem do produto */
        .main-image {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            height: 400px;
            border: 1px solid #eee;
        }
        
        .main-image img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }
        
        .thumbnail-images {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            padding: 5px;
        }
        
        .thumbnail.active {
            border-color: #4A6FA5;
        }
        
        .thumbnail img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }
        
        @media (max-width: 768px) {
            .product-simple {
                grid-template-columns: 1fr;
            }
            
            .main-image {
                height: 300px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Container para o Header (será preenchido pelo components.js) -->
    <div id="header-component">
        <!-- Header será carregado aqui dinamicamente -->
        <div class="loading-placeholder" style="height: 80px;"></div>
    </div>

    <!-- Detalhes do Produto -->
    <section class="product-detail">
        <div class="container">
            <div class="product-simple" id="product-container">
                <!-- Loading placeholder será substituído -->
                <div class="loading-placeholder" style="height: 500px; grid-column: 1 / -1;"></div>
            </div>
            
            <!-- Produtos Relacionados -->
            <div class="related-products">
                <h2>Produtos Relacionados</h2>
                <div class="products-grid" id="related-products">
                    <!-- Produtos relacionados serão carregados via JavaScript -->
                    <div class="product-card loading-placeholder" style="height: 400px; border-radius: 12px;"></div>
                    <div class="product-card loading-placeholder" style="height: 400px; border-radius: 12px;"></div>
                    <div class="product-card loading-placeholder" style="height: 400px; border-radius: 12px;"></div>
                    <div class="product-card loading-placeholder" style="height: 400px; border-radius: 12px;"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Container para o Footer (será preenchido pelo components.js) -->
    <div id="footer-component">
        <!-- Footer será carregado aqui dinamicamente -->
        <div class="loading-placeholder" style="height: 300px;"></div>
    </div>

    <!-- Scripts -->
    <script src="js/components.js"></script>
    <script src="js/produtos.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Script específico para página de produto
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Iniciando página de produto...');
            
            // Aguardar componentes carregarem
            const waitForComponents = setInterval(function() {
                if (document.querySelector('#header-component header') && 
                    document.querySelector('#footer-component footer')) {
                    clearInterval(waitForComponents);
                    initProductPage();
                }
            }, 100);
            
            // Timeout para segurança
            setTimeout(function() {
                clearInterval(waitForComponents);
                initProductPage();
            }, 3000);
        });
        
        function initProductPage() {
            // Verificar parâmetro de produto na URL
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            // Remover placeholders de loading primeiro
            removeLoadingPlaceholders();
            
            if (productId && window.produtos && Array.isArray(window.produtos)) {
                // Converter ID para número
                const id = parseInt(productId);
                
                // Encontrar produto pelo ID
                const product = window.produtos.find(p => p.id === id);
                
                if (product) {
                    // Atualizar informações do produto
                    displayProductDetails(product);
                    
                    // Carregar produtos relacionados
                    loadRelatedProducts(product);
                } else {
                    // Produto não encontrado
                    showProductNotFound(`Produto com ID ${id} não encontrado.`);
                }
            } else {
                // Sem ID de produto ou sem produtos carregados
                showProductNotFound(productId ? `Produto não disponível.` : 'Nenhum produto selecionado.');
            }
        }
        
        function removeLoadingPlaceholders() {
            // Remover classes de loading placeholder
            const placeholders = document.querySelectorAll('.loading-placeholder');
            placeholders.forEach(el => {
                el.classList.remove('loading-placeholder');
                el.innerHTML = '';
            });
        }
        
        function showProductNotFound(message = 'O produto que você está procurando não está disponível.') {
            const container = document.getElementById('product-container');
            if (container) {
                container.innerHTML = `
                    <div class="product-not-found" style="grid-column: 1 / -1;">
                        <i class="fas fa-search" style="font-size: 3rem; color: #6C757D; margin-bottom: 20px;"></i>
                        <h2>Produto não encontrado</h2>
                        <p>${message}</p>
                        <a href="produtos.html" class="whatsapp-button" style="background-color: #4A6FA5; margin-top: 20px;">
                            <i class="fas fa-store"></i> Ver todos os produtos
                        </a>
                    </div>
                `;
            }
        }
        
        function displayProductDetails(product) {
            const container = document.getElementById('product-container');
            if (!container) return;
            
            // Formatar preço
            const formatPrice = (price) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(price || 0);
            };
            
            // Gerar HTML das variações
            const variationsHTML = generateVariationsHTML(product);
            
            // Gerar HTML das características
            const featuresHTML = generateFeaturesHTML(product);
            
            // Construir mensagem para WhatsApp
            const whatsappMessage = `Olá! Gostaria de mais informações sobre o produto: ${product.nome} - ${formatPrice(product.preco)}. Pode me ajudar?`;
            const whatsappNumber = "5531990617185";
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(whatsappMessage)}`;
            
            // Construir HTML do produto
            let priceHTML = `<span class="current-price" style="font-size: 2rem; font-weight: bold; color: #4A6FA5;">${formatPrice(product.preco || 0)}</span>`;
            
            if (product.precoOriginal && product.precoOriginal > product.preco) {
                const discount = Math.round(100 - ((product.preco || 0) / product.precoOriginal) * 100);
                priceHTML += `
                    <div style="margin-top: 10px;">
                        <span style="font-size: 1.2rem; color: #999; text-decoration: line-through; margin-right: 10px;">
                            ${formatPrice(product.precoOriginal)}
                        </span>
                        <span style="background-color: #FF7E5F; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.9rem;">
                            -${discount}%
                        </span>
                    </div>
                `;
            }
            
            // URL da imagem padrão
            const defaultImage = product.imagem || 'assets/images/produtos/sem-imagem.jpg';
            
            // Atualizar container com HTML do produto
            container.innerHTML = `
                <!-- Imagem do Produto -->
                <div class="product-images">
                    <div class="main-image">
                        <img src="${defaultImage}" 
                             alt="${product.nome}" 
                             id="main-product-image"
                             data-default-image="${defaultImage}">
                    </div>
                    <div class="thumbnail-images" id="thumbnail-container">
                        <!-- Miniaturas serão adicionadas via JavaScript -->
                    </div>
                </div>
                
                <!-- Informações do Produto -->
                <div class="product-info">
                    <div class="product-breadcrumb">
                        <a href="index.html">Início</a> > 
                        <a href="produtos.html?categoria=${product.categoria || 'todos'}">
                            ${product.categoria ? product.categoria.charAt(0).toUpperCase() + product.categoria.slice(1) : 'Produtos'}
                        </a> > 
                        <span>${product.nome || 'Produto'}</span>
                    </div>
                    
                    <h1 style="color: #2C3E50; margin-bottom: 15px;">${product.nome || 'Produto'}</h1>
                    
                    <div class="product-price" id="product-price">
                        ${priceHTML}
                    </div>
                    
                    <div class="product-description">
                        <p style="font-size: 1.1rem; line-height: 1.6; color: #555;">${product.descricao || 'Descrição não disponível.'}</p>
                    </div>
                    
                    ${variationsHTML}
                    
                    <!-- Botão WhatsApp -->
                    <a href="${whatsappUrl}" target="_blank" class="whatsapp-button">
                        <i class="fab fa-whatsapp"></i> Pedir pelo WhatsApp
                    </a>
                    
                    ${featuresHTML}
                </div>
            `;
            
            // Configurar miniaturas
            setupThumbnails(product);
            
            // Configurar variações
            setupVariations(product);
        }
        
        function generateVariationsHTML(product) {
            // DADOS DE EXEMPLO - Você deve substituir pelos seus dados reais
            
            // Mapeamento de variações com imagens específicas
            const variationImages = {
                // Canecas
                'Caneca com Alça e Interior Colorido': {
                    'Alça Vermelha': 'assets/images/produtos/canecas/caneca-alca-vermelha.png',
                    'Alça Verde': 'assets/images/produtos/canecas/caneca-alca-verde.jpg', 
                    'Alça Azul': 'assets/images/produtos/canecas/caneca-alca-azul.jpg',
                    'Alça Preta': 'assets/images/produtos/canecas/caneca-alca-preta.jpg',
                    'Alça Rosa': 'assets/images/produtos/canecas/caneca-alca-rosa.jpg'
                },
                'Caneca Mágica': {
                    'Caneca Mágica Azul': 'assets/images/produtos/canecas/caneca-magica-preta.jpg'
                },
                'Caneca Porcelana Personalizada': {
                    'Porcelana Branca': 'assets/images/produtos/canecas/porcelana-branca.jpg'
                }
            };
            
            // Obter variações para este produto
            const productVariations = variationImages[product.nome] || product.variacoes || {};
            const variationKeys = Object.keys(productVariations);
            
            if (variationKeys.length === 0) {
                return '';
            }
            
            let optionsHTML = '';
            variationKeys.forEach((variationName, index) => {
                const variationImage = productVariations[variationName];
                const variationData = {
                    nome: variationName,
                    imagem: variationImage
                };
                
                const activeClass = index === 0 ? 'active' : '';
                
                optionsHTML += `
                    <button class="variation-btn ${activeClass}" 
                            data-variation='${JSON.stringify(variationData)}'>
                        ${variationName}
                    </button>
                `;
            });
            
            return `
                <div class="variations-container">
                    <h3 style="margin-bottom: 15px; color: #2C3E50;">Escolha a variação:</h3>
                    <div class="variation-options">
                        ${optionsHTML}
                    </div>
                </div>
            `;
        }
        
        function generateFeaturesHTML(product) {
            // Características padrão ou específicas do produto
            const defaultFeatures = [
                "Material de alta qualidade",
                "Personalização com sua arte ou texto",
                "Produção artesanal",
                "Embalagem especial para presente"
            ];
            
            const productFeatures = product.caracteristicas || defaultFeatures;
            
            let featuresList = '';
            productFeatures.forEach(feature => {
                featuresList += `<li><i class="fas fa-check"></i> ${feature}</li>`;
            });
            
            return `
                <div class="product-features">
                    <h3>Características do Produto</h3>
                    <ul>
                        ${featuresList}
                    </ul>
                </div>
            `;
        }
        
        function setupThumbnails(product) {
            const thumbnailContainer = document.getElementById('thumbnail-container');
            if (!thumbnailContainer) return;
            
            // Limpar miniaturas
            thumbnailContainer.innerHTML = '';
            
            // Adicionar miniatura principal
            const mainImage = document.getElementById('main-product-image');
            if (mainImage && mainImage.src) {
                addThumbnail(mainImage.src, product.nome, thumbnailContainer);
            }
            
            // Adicionar outras imagens se existirem
            if (product.imagensAdicionais && product.imagensAdicionais.length > 0) {
                product.imagensAdicionais.forEach(img => {
                    addThumbnail(img, product.nome, thumbnailContainer);
                });
            }
            
            // Ativar primeira miniatura
            if (thumbnailContainer.firstChild) {
                thumbnailContainer.firstChild.classList.add('active');
            }
        }
        
        function addThumbnail(src, alt, container) {
            const thumbnail = document.createElement('div');
            thumbnail.className = 'thumbnail';
            
            const img = document.createElement('img');
            img.src = src;
            img.alt = alt || 'Miniatura';
            img.onerror = function() {
                this.src = 'assets/images/produtos/sem-imagem.jpg';
            };
            
            thumbnail.appendChild(img);
            
            thumbnail.addEventListener('click', function() {
                // Atualizar imagem principal
                const mainImage = document.getElementById('main-product-image');
                if (mainImage) {
                    mainImage.src = src;
                    mainImage.alt = alt || 'Produto';
                }
                
                // Remover classe ativa de todas as miniaturas
                container.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                
                // Adicionar classe ativa à miniatura clicada
                this.classList.add('active');
            });
            
            container.appendChild(thumbnail);
        }
        
        function setupVariations(product) {
            const variationButtons = document.querySelectorAll('.variation-btn');
            const mainImage = document.getElementById('main-product-image');
            
            variationButtons.forEach((button, index) => {
                button.addEventListener('click', function() {
                    // Remover classe ativa de todos os botões
                    variationButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Adicionar classe ativa ao botão clicado
                    this.classList.add('active');
                    
                    // Obter dados da variação
                    const variationData = JSON.parse(this.getAttribute('data-variation'));
                    
                    // ATUALIZAR IMAGEM COM A IMAGEM DA VARAIAÇÃO
                    if (mainImage && variationData.imagem) {
                        mainImage.src = variationData.imagem;
                        mainImage.alt = variationData.nome;
                        
                        // Efeito de transição suave
                        mainImage.style.opacity = '0';
                        setTimeout(() => {
                            mainImage.style.opacity = '1';
                        }, 10);
                        
                        // Atualizar miniaturas para a variação selecionada
                        updateThumbnailsForVariation(variationData);
                    }
                    
                    // Atualizar informações com base na variação selecionada
                    updateProductForVariation(variationData, product);
                });
                
                // Ativar primeira variação por padrão
                if (index === 0) {
                    button.click();
                }
            });
        }
        
        function updateThumbnailsForVariation(variation) {
            const thumbnailContainer = document.getElementById('thumbnail-container');
            if (!thumbnailContainer || !variation.imagem) return;
            
            // Limpar miniaturas
            thumbnailContainer.innerHTML = '';
            
            // Adicionar miniatura da variação
            addThumbnail(variation.imagem, variation.nome, thumbnailContainer);
            
            // Aqui você pode adicionar mais imagens para esta variação específica
            // Exemplo: se tiver imagens adicionais para esta variação
            if (variation.imagensAdicionais) {
                variation.imagensAdicionais.forEach(img => {
                    addThumbnail(img, variation.nome, thumbnailContainer);
                });
            }
            
            // Ativar primeira miniatura
            if (thumbnailContainer.firstChild) {
                thumbnailContainer.firstChild.classList.add('active');
            }
        }
        
        function updateProductForVariation(variation, originalProduct) {
            console.log('Variação selecionada:', variation);
            
            // Atualizar título se necessário
            const titleElement = document.querySelector('.product-info h1');
            if (titleElement && variation.nome) {
                titleElement.textContent = `${originalProduct.nome} - ${variation.nome}`;
            }
            
            // Atualizar mensagem do WhatsApp com a variação
            const whatsappButton = document.querySelector('.whatsapp-button');
            if (whatsappButton && variation.nome) {
                const newMessage = `Olá! Gostaria de mais informações sobre o produto: ${originalProduct.nome} - ${variation.nome}. Pode me ajudar?`;
                const whatsappNumber = "5531990617185";
                const newWhatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(newMessage)}`;
                whatsappButton.href = newWhatsappUrl;
            }
        }
        
        function loadRelatedProducts(currentProduct) {
            const relatedContainer = document.getElementById('related-products');
            if (!relatedContainer) return;
            
            relatedContainer.innerHTML = '';
            
            if (window.produtos && Array.isArray(window.produtos)) {
                // Filtrar produtos da mesma categoria (excluindo o atual)
                const relatedProducts = window.produtos.filter(p => 
                    p.categoria === currentProduct.categoria && p.id !== currentProduct.id
                ).slice(0, 4);
                
                if (relatedProducts.length > 0) {
                    // Adicionar produtos relacionados
                    relatedProducts.forEach(product => {
                        const productCard = createSimpleProductCard(product);
                        relatedContainer.appendChild(productCard);
                    });
                } else {
                    relatedContainer.innerHTML = '<p class="no-related">Não há produtos relacionados no momento.</p>';
                }
            }
        }
        
        function createSimpleProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.style.cursor = 'pointer';
            
            const hasDiscount = product.precoOriginal && product.precoOriginal > product.preco;
            const discountPercentage = hasDiscount ? 
                Math.round(100 - ((product.preco || 0) / product.precoOriginal) * 100) : 0;
            
            card.innerHTML = `
                <div class="product-image">
                    <img src="${product.imagem || 'assets/images/produtos/sem-imagem.jpg'}" 
                         alt="${product.nome || 'Produto'}" 
                         style="width: 100%; height: 200px; object-fit: contain; padding: 10px;">
                    ${hasDiscount ? `<span class="product-badge">-${discountPercentage}%</span>` : ''}
                </div>
                <div class="product-info">
                    <div class="product-category">${product.categoria ? product.categoria.charAt(0).toUpperCase() + product.categoria.slice(1) : 'Produto'}</div>
                    <h3 class="product-name">${product.nome || 'Produto'}</h3>
                    <p class="product-description">${(product.descricao || '').substring(0, 60)}...</p>
                    <div class="product-price">
                        <span class="current-price">${formatPrice(product.preco || 0)}</span>
                        ${hasDiscount ? 
                            `<span class="original-price">${formatPrice(product.precoOriginal)}</span>` : ''}
                    </div>
                </div>
            `;
            
            // Toda a card é clicável
            card.addEventListener('click', function() {
                window.location.href = `produto.html?id=${product.id || '1'}`;
            });
            
            return card;
        }
        
        function formatPrice(price) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(price);
        }
    </script>
</body>
</html>
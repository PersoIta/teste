<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrinho de Compras - PersoIta</title>
    <meta name="description" content="Seu carrinho de compras na PersoIta. Revise seus produtos personalizados antes de finalizar o pedido.">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos de loading */
        .component-loading {
            text-align: center;
            padding: 20px;
            color: #6C757D;
        }
        
        .loading-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <!-- Container para o Header -->
    <div id="header-component">
        <div class="loading-placeholder" style="height: 80px;"></div>
    </div>

    <!-- Cabeçalho do Carrinho -->
    <section class="page-header">
        <div class="container">
            <h1>Meu Carrinho</h1>
            <p>Revise seus produtos personalizados antes de finalizar o pedido</p>
        </div>
    </section>

    <!-- Conteúdo do Carrinho -->
    <section class="cart-section">
        <div class="container">
            <div class="cart-content" id="cart-content">
                <!-- Conteúdo será carregado via JavaScript -->
                <div class="loading-placeholder" style="height: 300px;"></div>
            </div>
        </div>
    </section>

    <!-- Container para o footer -->
    <div id="footer-component">
        <div class="loading-placeholder" style="height: 300px;"></div>
    </div>

    <!-- Scripts -->
    <script src="js/components.js"></script>
    <script src="js/produtos.js"></script>
    <script src="js/main.js"></script>
    <script src="js/carrinho.js"></script>
    <script>
        // Script específico para página do carrinho
        document.addEventListener('DOMContentLoaded', function() {
            // Aguardar componentes carregarem
            const waitForComponents = setInterval(function() {
                if (document.querySelector('#header-component header') && 
                    document.querySelector('#footer-component footer')) {
                    clearInterval(waitForComponents);
                    initCartPage();
                }
            }, 100);
            
            // Timeout para segurança
            setTimeout(function() {
                clearInterval(waitForComponents);
                initCartPage();
            }, 3000);
        });
        
        function initCartPage() {
            console.log('Inicializando página do carrinho...');
            loadCartPage();
        }
        
        function loadCartPage() {
            const cartContent = document.getElementById('cart-content');
            if (!cartContent) return;
            
            // Remover loading
            cartContent.classList.remove('loading-placeholder');
            cartContent.innerHTML = '';
            
            // Verificar se as funções do carrinho estão disponíveis
            if (typeof getCart !== 'function') {
                cartContent.innerHTML = `
                    <div class="error-message" style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h2>Erro no carrinho</h2>
                        <p>As funções do carrinho não foram carregadas corretamente.</p>
                        <button onclick="location.reload()" class="btn-primary" style="margin-top: 20px;">
                            Recarregar Página
                        </button>
                    </div>
                `;
                return;
            }
            
            // Obter carrinho
            const cart = getCart();
            
            if (cart.length === 0) {
                showEmptyCart(cartContent);
            } else {
                showCartWithItems(cart, cartContent);
            }
        }
        
        function showEmptyCart(container) {
            container.innerHTML = `
                <div class="cart-items">
                    <div class="cart-header">
                        <h2>Produtos Selecionados</h2>
                    </div>
                    
                    <div class="empty-cart-message">
                        <i class="fas fa-shopping-cart" style="font-size: 4rem; color: #E9ECEF; margin-bottom: 20px;"></i>
                        <h3>Seu carrinho está vazio</h3>
                        <p>Adicione produtos personalizados para ver eles aqui.</p>
                        <a href="produtos.html" class="btn-primary">Ver Produtos</a>
                    </div>
                </div>
                
                <div class="cart-summary">
                    <h2>Resumo do Pedido</h2>
                    
                    <div class="summary-details">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>R$ 0,00</span>
                        </div>
                        <div class="summary-row total-row">
                            <span><strong>Total</strong></span>
                            <span><strong>R$ 0,00</strong></span>
                        </div>
                    </div>
                    
                    <button class="btn-primary checkout-btn" disabled style="opacity: 0.6;">
                        <i class="fas fa-shopping-cart"></i> Carrinho Vazio
                    </button>
                </div>
            `;
        }
        
        function showCartWithItems(cart, container) {
            let subtotal = 0;
            let itemsHTML = '';
            
            // Calcular subtotal e criar HTML dos itens
            cart.forEach((item, index) => {
                const product = window.produtos.find(p => p.id == item.id);
                if (!product) return;
                
                const itemTotal = product.preco * item.quantity;
                subtotal += itemTotal;
                
                // HTML do item
                itemsHTML += `
                    <div class="cart-item">
                        <div class="cart-item-image">
                            <img src="${product.imagem}" alt="${product.nome}" 
                                 onerror="this.onerror=null; this.src='assets/images/produtos/sem-imagem.jpg'">
                        </div>
                        <div class="cart-item-details">
                            <div class="cart-item-header">
                                <h3>${product.nome}</h3>
                                <button class="remove-item-btn" onclick="removeCartItem(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <p class="cart-item-category">${product.categoria ? product.categoria.charAt(0).toUpperCase() + product.categoria.slice(1) : 'Produto'}</p>
                            <p class="cart-item-description">${product.descricao ? product.descricao.substring(0, 100) + '...' : ''}</p>
                            
                            ${item.customizations && Object.keys(item.customizations).length > 0 ? 
                                `<div class="cart-item-customizations">
                                    <strong>Personalizações:</strong>
                                    <ul>
                                        ${Object.entries(item.customizations).map(([key, value]) => 
                                            `<li>${formatCustomization(key)}: ${value}</li>`
                                        ).join('')}
                                    </ul>
                                </div>` : ''}
                            
                            <div class="cart-item-footer">
                                <div class="cart-item-quantity">
                                    <button class="quantity-btn minus" onclick="updateQuantity(${index}, -1)">-</button>
                                    <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="10" 
                                           onchange="updateQuantityExact(${index}, this.value)">
                                    <button class="quantity-btn plus" onclick="updateQuantity(${index}, 1)">+</button>
                                </div>
                                <div class="cart-item-price">
                                    <span class="item-total">${formatPrice(itemTotal)}</span>
                                    <span class="item-unit">${formatPrice(product.preco)} cada</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = `
                <div class="cart-items">
                    <div class="cart-header">
                        <h2>Produtos Selecionados (${cart.length})</h2>
                        <button class="clear-cart-btn" onclick="clearCartAndReload()">
                            <i class="fas fa-trash"></i> Limpar Carrinho
                        </button>
                    </div>
                    
                    <div class="cart-items-list">
                        ${itemsHTML}
                    </div>
                </div>
                
                <div class="cart-summary">
                    <h2>Resumo do Pedido</h2>
                    
                    <div class="summary-details">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>${formatPrice(subtotal)}</span>
                        </div>
                        <div class="summary-row">
                            <span>Frete</span>
                            <span>Grátis acima de R$ 100</span>
                        </div>
                        <div class="summary-divider"></div>
                        <div class="summary-row total-row">
                            <span><strong>Total</strong></span>
                            <span><strong>${formatPrice(subtotal)}</strong></span>
                        </div>
                    </div>
                    
                    <button class="btn-primary checkout-btn" onclick="finalizeOrder()">
                        <i class="fab fa-whatsapp"></i> Finalizar Pedido no WhatsApp
                    </button>
                    
                    <p class="secure-checkout">
                        <i class="fas fa-lock"></i> Compra 100% segura
                    </p>
                </div>
            `;
        }
        
        // Funções auxiliares
        function formatPrice(price) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(price);
        }
        
        function formatCustomization(key) {
            const translations = {
                'textoPersonalizado': 'Texto',
                'cor': 'Cor',
                'imagemPersonalizada': 'Imagem'
            };
            return translations[key] || key;
        }
        
        function removeCartItem(index) {
            if (confirm('Remover este item do carrinho?')) {
                if (typeof removeFromCart === 'function') {
                    removeFromCart(index);
                    loadCartPage();
                    if (typeof updateCartCount === 'function') {
                        updateCartCount();
                    }
                }
            }
        }
        
        function updateQuantity(index, change) {
            if (typeof updateCartItemQuantity === 'function') {
                updateCartItemQuantity(index, change);
                loadCartPage();
                if (typeof updateCartCount === 'function') {
                    updateCartCount();
                }
            }
        }
        
        function updateQuantityExact(index, value) {
            const newQuantity = parseInt(value);
            if (isNaN(newQuantity) || newQuantity < 1 || newQuantity > 10) {
                // Recarregar para mostrar valor correto
                loadCartPage();
                return;
            }
            
            if (typeof updateCartItemQuantity === 'function') {
                updateCartItemQuantity(index, newQuantity, true);
                loadCartPage();
                if (typeof updateCartCount === 'function') {
                    updateCartCount();
                }
            }
        }
        
        function clearCartAndReload() {
            if (confirm('Tem certeza que deseja limpar todo o carrinho?')) {
                if (typeof clearCart === 'function') {
                    clearCart();
                    loadCartPage();
                    if (typeof updateCartCount === 'function') {
                        updateCartCount();
                    }
                }
            }
        }
        
        function finalizeOrder() {
            const cart = getCart();
            if (cart.length === 0) {
                alert('Seu carrinho está vazio!');
                return;
            }
            
            // Calcular total
            let total = 0;
            let itemsDetails = '';
            
            cart.forEach((item, index) => {
                const product = window.produtos.find(p => p.id == item.id);
                if (product) {
                    const itemTotal = product.preco * item.quantity;
                    total += itemTotal;
                    
                    itemsDetails += `*${index + 1}. ${product.nome}*\n`;
                    itemsDetails += `   Quantidade: ${item.quantity}\n`;
                    itemsDetails += `   Valor unitário: ${formatPrice(product.preco)}\n`;
                    itemsDetails += `   Subtotal: ${formatPrice(itemTotal)}\n`;
                    
                    if (item.customizations) {
                        itemsDetails += `   Personalizações:\n`;
                        if (item.customizations.textoPersonalizado) {
                            itemsDetails += `   • Texto: "${item.customizations.textoPersonalizado}"\n`;
                        }
                        if (item.customizations.cor && item.customizations.cor !== 'branco') {
                            itemsDetails += `   • Cor: ${item.customizations.cor}\n`;
                        }
                        if (item.customizations.imagemPersonalizada === 'Sim') {
                            itemsDetails += `   • Com imagem personalizada\n`;
                        }
                    }
                    itemsDetails += `\n`;
                }
            });
            
            // Criar mensagem para WhatsApp
            const message = `*PEDIDO - PersoIta Produtos Personalizados*\n\n` +
                           `Olá! Gostaria de fazer um pedido:\n\n` +
                           `${itemsDetails}\n` +
                           `*TOTAL: ${formatPrice(total)}*\n\n` +
                           `Por favor, me informe como proceder com o pagamento e entrega.`;
            
            const whatsappNumber = "5531990617185";
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
        }
    </script>
</body>
</html>